---
title: OSCamp D18-rCore Chapter 6-Structure
date: 2024-04-25 06:01:14
tags: [Rust, RISC-V, FileSystem]
category: [OSCamp]
---

第五章的内容之后有时间再补充，我只做了fork的COW和多核(core)支持，其他调度算法没做，因为主要是苦力活、分值少、还浪费时间。

第二阶段就要开始了，时间紧迫，容不得我慢慢写博客，接下来必须提速。我必须在第三阶段结束前自己从头实现一个内核。

这一篇文章目的是整理easyfs的结构，主要是理论知识。

<!--more-->

# 磁盘和文件系统

磁盘的物理结构如下：

* 盘片：单面或两面有磁性物质的圆形片，磁盘一般有多个盘片，数据储存在上面
* 磁头：用来读写数据的探头
* 磁道：磁片上的多个同心圆
* 扇区(sector)：对磁道的分割，越是外圈的磁道扇区越多，最开始一个扇区是512Byte，如今扇区是4096Byte(即4K)，但是也保持向后兼容
* 柱面：不同盘片上相同半径的磁道，构成一个空心圆柱，故称柱面

磁盘的逻辑结构如下，随软件或约定而变：

* 块(block)：磁盘**读写**的最小单位，ext4的块是4K，easyfs的块是512B
* 分区(partition)：将磁盘分成数个相互独立的区域，用于不同用途，很古老的管理方式，如今个人用户并不推荐分区
* 文件(file)：由元数据(名称、大小、修改时间、访问权限等)和内容(固定大小的字节流)构成，文件系统不考虑文件内容的意义
* 目录(directory/folder)：元数据与文件类似，但是持有的内容只用于索引其他文件

磁盘的物理结构可以类比内存，都是线性寻址、随机访问的存储空间，区别在于：
* 磁盘的存储是持久的，不易出错，断电不易丢失数据，访问速度慢
* 内存断电后数据丢失，易出错，需要ECC等机制来检查和修正错误

类比于分页机制用来管理内存，文件系统则用来管理硬盘的存储空间，或者说文件系统的目的是：

> 在硬盘的物理结构上抽象出一层逻辑结构，以便操作系统的管理和用户软件的访问。

# easyfs

easyfs的物理结构分成按顺序的、不间断的五个区域：
* 超级块(superblock)：大小为512B，**固定在硬盘的头部**，即第一个块，储存了整个文件系统的所有信息。
* 索引Bitmap：整数个块，按顺序的每个bit记录对应**索引的状态**，0表示未分配，1表示已分配
* 索引：整数个块，每个块储存四个`DiskInode`
* 数据Bitmap：整数个块，按顺序的每个bit记录数据区域的**块的状态**，0表示未分配，1表示已分配
* 数据：整数个块，所有数据都分配和储存在此

easyfs的逻辑结构是一棵树，每一个节点都是一个`DiskInode`：
* 具有长度(单位Byte)，长度除以块大小(512B)即是它逻辑上"占有"的块数量。根据计算最多能占有`8M+64K+14K`那么多字节，内容有两种可能：
* 非叶子节点：也就是目录，那么长度除以`DirEntry`就是它的**子节点**的数量，所以一个目录下最多有264640个项。
* 叶子节点：也就是文件，内容就是文件的数据，所以一个文件最大不过8M多一点。

一个`DirEntry`具有两个数据：定长的名称和一个DiskInode，总长度是32B，其中前28个Byte是名称，以0结尾。



